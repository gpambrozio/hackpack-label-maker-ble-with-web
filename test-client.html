<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Label Maker Client</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rubik:wght@400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        :root {
            --bg: #0b0b0c;
            /* deep black, painted plywood */
            --panel: #111213;
            --panel-2: #17181a;
            /* purple touches */
            --wood-1: #a47148;
            /* warm plywood core */
            --wood-2: #8b5e3c;
            --wood-3: #c18f59;
            --text: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(1200px 800px at 15% 10%, rgba(124, 58, 237, .12), transparent 60%),
                radial-gradient(1000px 700px at 85% 90%, rgba(124, 58, 237, .1), transparent 55%),
                var(--bg);
            color: var(--text);
        }

        /* Device "case" with wood rails */
        .device-case {
            position: relative;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            box-shadow: 0 20px 60px rgba(0, 0, 0, .6), inset 0 1px 0 rgba(255, 255, 255, .06);
            overflow: visible;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 2rem);
            /* fill screen minus body padding */
            isolation: isolate;
        }

        .device-case::before,
        .device-case::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        /* subtle brushed effect */
        .device-case::before {
            background: repeating-linear-gradient(90deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .03) 2px, transparent 2px, transparent 6px);
            mix-blend-mode: overlay;
            opacity: .3;
        }

        /* wood rails */
        .wood-rails {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }

        .wood-rail {
            position: absolute;
            height: 20px;
            left: -16px;
            right: -16px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .08), inset 0 -1px 0 rgba(0, 0, 0, .55), 0 2px 8px rgba(0, 0, 0, .6);
        }

        .wood-rail.top {
            top: 10px;
        }

        .wood-rail.bottom {
            bottom: 10px;
        }

        .wood-grain {
            background:
                linear-gradient(0deg, rgba(0, 0, 0, .15), transparent 20%, transparent 80%, rgba(0, 0, 0, .25)),
                repeating-linear-gradient(0deg, var(--wood-2) 0px, var(--wood-2) 9px, var(--wood-1) 9px, var(--wood-1) 16px, var(--wood-3) 16px, var(--wood-3) 27px);
        }

        /* Engraved label style */
        .engraved {
            font-family: 'Rubik', sans-serif;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #dbc7b6;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.35), 0 -1px 0 rgba(0, 0, 0, 0.6);
            mix-blend-mode: normal;
        }

        /* Purple screws (decorative) */
        .screw {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #bca6ff, #7c3aed 55%, #4c1d95 90%);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, .25), 0 2px 8px rgba(124, 58, 237, .35);
            position: absolute;
        }

        /* Button styling */
        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            border-radius: 0;
            padding: .8rem 1rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(180deg, rgba(139, 92, 246, .95), rgba(109, 40, 217, .95));
            box-shadow: 0 8px 22px rgba(124, 58, 237, .35), 0 0 0 1px rgba(124, 58, 237, .35), inset 0 1px 0 rgba(255, 255, 255, .06);
            transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
        }

        .btn:hover {
            box-shadow: 0 10px 26px rgba(124, 58, 237, .45), 0 0 0 1px rgba(124, 58, 237, .45);
            filter: saturate(1.06);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn[disabled] {
            opacity: .5;
            filter: grayscale(.2);
            cursor: not-allowed;
        }

        .btn-sm {
            padding: .55rem .75rem;
            font-size: .875rem;
            gap: .4rem;
        }

        .btn-secondary {
            background: linear-gradient(180deg, rgba(71, 85, 105, .6), rgba(51, 65, 85, .6));
            backdrop-filter: blur(4px);
            box-shadow: 0 8px 22px rgba(2, 6, 23, .45), 0 0 0 1px rgba(148, 163, 184, .25), inset 0 1px 0 rgba(255, 255, 255, .05);
        }

        /* Inputs */
        .input {
            background: #0f1113;
            border: 1px solid rgba(148, 163, 184, .25);
            color: #e5e7eb;
            border-radius: 0;
            padding: .75rem .9rem;
            outline: none;
            transition: border-color .2s ease, box-shadow .2s ease;
        }

        .input:focus {
            border-color: rgba(124, 58, 237, .8);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, .25);
        }

        /* Slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            width: 100%;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: linear-gradient(90deg, rgba(124, 58, 237, .8), rgba(124, 58, 237, .35));
            border-radius: 999px;
        }

        input[type="range"]::-moz-range-track {
            height: 6px;
            background: linear-gradient(90deg, rgba(124, 58, 237, .8), rgba(124, 58, 237, .35));
            border-radius: 999px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: radial-gradient(circle at 30% 30%, #bca6ff, #7c3aed 55%, #4c1d95 90%);
            border-radius: 50%;
            margin-top: -6px;
            box-shadow: 0 2px 10px rgba(124, 58, 237, .5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: radial-gradient(circle at 30% 30%, #bca6ff, #7c3aed 55%, #4c1d95 90%);
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 10px rgba(124, 58, 237, .5);
        }

        /* Preview frame */
        .preview-frame {
            position: relative;
            background: #0f0f10;
            border-radius: 0;
            padding: 14px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06), inset 0 -1px 0 rgba(0, 0, 0, .6), 0 16px 40px rgba(0, 0, 0, .55);
        }

        /* Purple tape surface behind SVG */
        .tape-surface {
            padding: 10px;
            background:
                linear-gradient(180deg, rgba(92, 39, 211, .35), rgba(92, 39, 211, .35)),
                repeating-linear-gradient(135deg, rgba(124, 58, 237, .25) 0px, rgba(124, 58, 237, .25) 6px, rgba(76, 29, 149, .25) 6px, rgba(76, 29, 149, .25) 12px);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06), inset 0 -1px 0 rgba(0, 0, 0, .45);
        }

        /* LCD-style status */
        .lcd {
            background: linear-gradient(180deg, #1d3b63, #0f2742);
            color: #d6f0ff;
            border: 1px solid #0a1d33;
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, .6), 0 1px 0 rgba(255, 255, 255, .05);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            letter-spacing: 0.04em;
            text-transform: none;
            padding: .75rem 1rem;
        }

        /* Logo cutout: wooden fill inside text only */
        .logo-cutout {
            font-family: 'Rubik', sans-serif;
            font-weight: 800;
            font-size: 1.25rem;
            letter-spacing: .18em;
            text-transform: uppercase;
            background:
                linear-gradient(0deg, rgba(0, 0, 0, .15), transparent 20%, transparent 80%, rgba(0, 0, 0, .25)),
                repeating-linear-gradient(0deg, var(--wood-2) 0px, var(--wood-2) 9px, var(--wood-1) 9px, var(--wood-1) 16px, var(--wood-3) 16px, var(--wood-3) 27px);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            /* text-shadow: 0 1px 0 rgba(255, 255, 255, .18), 0 -1px 0 rgba(0, 0, 0, .65); */
        }

        /* Tape-style tabs */
        .tabs {
            display: flex;
            gap: .5rem;
            align-items: center;
        }

        .tab {
            user-select: none;
            cursor: pointer;
            border: 1px solid rgba(148, 163, 184, .25);
            padding: .6rem .9rem;
            color: #e5e7eb;
            background: linear-gradient(180deg, rgba(30, 41, 59, .55), rgba(15, 23, 42, .45));
            box-shadow: 0 1px 0 rgba(255, 255, 255, .06) inset, 0 6px 16px rgba(0, 0, 0, .45);
            backdrop-filter: blur(4px);
        }

        .tab:hover {
            filter: saturate(1.05);
        }

        .tab.active {
            color: #fff;
            border-color: rgba(124, 58, 237, .6);
            background:
                linear-gradient(180deg, rgba(92, 39, 211, .55), rgba(92, 39, 211, .55)),
                repeating-linear-gradient(135deg, rgba(124, 58, 237, .25) 0px, rgba(124, 58, 237, .25) 6px, rgba(76, 29, 149, .25) 6px, rgba(76, 29, 149, .25) 12px);
            box-shadow: 0 0 0 1px rgba(124, 58, 237, .35), 0 10px 24px rgba(124, 58, 237, .25);
        }
    </style>
</head>

<body class="min-h-screen p-4">
    <div class="w-full device-case p-6 md:p-8">
        <div class="wood-rails" aria-hidden="true">
            <div class="wood-rail top wood-grain"></div>
            <div class="wood-rail bottom wood-grain"></div>
        </div>

        <div class="flex gap-6 mb-6">
            <!-- Top nameplate -->
            <div class="w-fit  relative z-10 px-4 py-2">
                <span class="logo-cutout">Label Maker</span>

                <!-- Decorative purple joystick/screws cluster -->
                <div class="absolute w-full h-full top-0 left-0">
                    <div class="screw" style="left:0; top:0"></div>
                    <div class="screw" style="right:0; top:0"></div>
                    <div class="screw" style="left:0; bottom:0"></div>
                    <div class="screw" style="right:0; bottom:0"></div>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="flex items-center gap-2">
                <button id="connectButton" class="btn btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M7 17L17 7L12 2V22L17 17L7 7" stroke="white" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    Connect
                </button>
                <button id="disconnectButton" class="btn btn-secondary btn-sm" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 12h6m0 0l-3-3m3 3l-3 3M14 6h4a2 2 0 012 2v8a2 2 0 01-2 2h-4" stroke="white"
                            stroke-width="2" stroke-linecap="round" />
                    </svg>
                    Disconnect
                </button>
            </div>

            <div>
                <div id="status" class="lcd text-xs sm:text-sm">
                    Status: Ready to connect.
                </div>
            </div>
        </div>

        <!-- Main content (tabs + sections) -->
        <div class="relative z-10 flex flex-col gap-3 flex-1 min-h-0">
            <div class="tabs">
                <button id="tabGcode" class="tab active">G-code</button>
                <button id="tabText" class="tab">Text</button>
                <button id="tabRaw" class="tab">Raw</button>
            </div>

            <div class="flex-1 min-h-0 overflow-auto">
                <!-- Text section -->
                <section id="sectionText" class="relative z-10 space-y-3 h-full hidden">
                    <div class="space-y-2">
                        <label class="engraved text-sm opacity-80">Text to plot</label>
                        <div class="flex gap-2">
                            <input id="labelText" type="text" placeholder="Enter label text" class="input w-full"
                                maxlength="12" />
                            <button id="sendTextButton" class="btn btn-sm" disabled>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 2L11 13" stroke="white" stroke-width="2" />
                                    <path d="M22 2l-7 20-4-9-9-4 20-7z" stroke="white" stroke-width="2" fill="none" />
                                </svg>
                                Send
                            </button>
                        </div>
                    </div>
                </section>

                <!-- G-code section -->
                <section id="sectionGcode" class="relative z-10 space-y-3 h-full">
                    <div class="space-y-2">

                        <div class="engraved text-sm opacity-80">G-Code Preview</div>

                        <div class="flex items-center gap-3 max-w-md">
                            <label for="thicknessSlider" class="text-xs text-slate-300">Tool thickness</label>
                            <input id="thicknessSlider" type="range" min="0.2" max="5" step="0.1" value="2"
                                class="w-44">
                            <span id="thicknessValue" class="text-xs text-slate-400">2.0 mm</span>
                            <span class="text-xs text-slate-400">Area: 260 × 30 mm</span>
                        </div>
                        <div class="preview-frame">
                            <div class="tape-surface"
                                style="overflow:hidden; width: 100%; max-width: 260mm; aspect-ratio: 260/34;">
                                <div class="relative">
                                    <svg id="gcodePreview" class="overflow-visible"
                                        style="width: 100%; max-width: 260mm; aspect-ratio: 260/30; display:block;"
                                        viewBox="0 0 260 30" preserveAspectRatio="xMidYMid meet"></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label for="gcodeTextarea" class="engraved text-sm opacity-80">G-code (mm, origin at
                            bottom-left)</label>
                        <textarea id="gcodeTextarea" rows="12" class="input w-full font-mono text-sm"
                            placeholder="Enter G-code here"></textarea>
                        <div class="flex items-center gap-2">
                            <button id="sendSampleGcodeButton" class="btn btn-sm" disabled>Send G-code</button>
                            <button id="resetToSampleButton" class="btn btn-secondary btn-sm" title="Load sample ruler into viewer">Load sample ruler</button>
                            <button id="loadCrunchLabsButton" class="btn btn-secondary btn-sm" title="Load Crunch Labs logo sample into viewer">
                                Load Crunch Labs Logo
                            </button>
                        </div>
                    </div>

                </section>

                <!-- Raw section -->
                <section id="sectionRaw" class="relative z-10 space-y-3 h-full hidden">
                    <div class="flex items-center gap-2">
                        <button id="penDownButton" class="btn btn-sm" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 18h12M8 14l8-8 2 2-8 8H8v-2z" stroke="white" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            Pen Down
                        </button>
                        <button id="penUpButton" class="btn btn-secondary btn-sm" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 18h12M16 10l-2-2-6 6v2h2l6-6z" stroke="white" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            Pen Up
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Status now lives in toolbar -->
    </div>

    <script>
        // Global variables to hold the device and characteristic
        let labelMakerDevice = null;
        let labelMakerCharacteristic = null;

        // UUIDs from the Arduino code
        const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
        const CHARACTERISTIC_UUID = '87654321-4321-8765-4321-87654321fedc';

        // Get UI elements
        const connectButton = document.getElementById('connectButton');
        const penDownButton = document.getElementById('penDownButton');
        const penUpButton = document.getElementById('penUpButton');
        const sendTextButton = document.getElementById('sendTextButton');
        const sendSampleGcodeButton = document.getElementById('sendSampleGcodeButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const labelTextInput = document.getElementById('labelText');
        const statusDiv = document.getElementById('status');
        const gcodeTextarea = document.getElementById('gcodeTextarea');
        const resetToSampleButton = document.getElementById('resetToSampleButton');
    const loadCrunchLabsButton = document.getElementById('loadCrunchLabsButton');
        const gcodePreview = document.getElementById('gcodePreview');
        const thicknessSlider = document.getElementById('thicknessSlider');
        const thicknessValue = document.getElementById('thicknessValue');

        // Preview stroke width in mm
        let currentStrokeWidth = 2.0;

    /**
     * Updates the status message on the UI.
     * @param {string} message The message to display.
     */
    const updateStatus = (message) => {
            statusDiv.textContent = `Status: ${message}`;
        };

        /**
         * Connects to the Bluetooth device.
         */
        const connectDevice = async () => {
            try {
                updateStatus('Connecting...');

                // Request a Bluetooth device
                labelMakerDevice = await navigator.bluetooth.requestDevice({
                    // filters: [{ namePrefix: 'LABEL' }],
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                // Add event listener for device disconnects
                labelMakerDevice.addEventListener('gattserverdisconnected', onDisconnected);

                // Connect to the GATT server
                updateStatus('Connecting to GATT server...');
                const server = await labelMakerDevice.gatt.connect();

                // Get the primary service
                updateStatus('Getting service...');
                const service = await server.getPrimaryService(SERVICE_UUID);

                // Get the characteristic
                updateStatus('Getting characteristic...');
                labelMakerCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                updateStatus('Connected successfully!');

                // Enable UI elements after successful connection
                connectButton.disabled = true;
                penDownButton.disabled = false;
                penUpButton.disabled = false;
                sendTextButton.disabled = false;
                sendSampleGcodeButton.disabled = false;
                disconnectButton.disabled = false;

            } catch (error) {
                updateStatus(`Connection failed: ${error}`);
                console.error('Connection error:', error);
            }
        };

        /**
         * Write a command string to the device characteristic.
         */
        const writeCommand = async (command) => {
            if (!labelMakerCharacteristic) {
                updateStatus('Not connected!');
                return;
            }
            try {
                //updateStatus('Sending command...');
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                if (data.byteLength > 512) {
                    throw new Error(`Payload ${data.byteLength} exceeds 512 bytes`);
                }
                await labelMakerCharacteristic.writeValue(data);
                //updateStatus(`Command sent: "${command.slice(0, 60)}${command.length > 60 ? '…' : ''}"`);
            } catch (error) {
                updateStatus(`Failed to send command: ${error}`);
                console.error('Send command error:', error);
            }
        };

        // Write a potentially long G-code using chunked protocol
        const sendGcodeChunked = async (program) => {
            if (!labelMakerCharacteristic) {
                updateStatus('Not connected.');
                return;
            }
            const encoder = new TextEncoder();
            const MAX_PAYLOAD = 480; // leave headroom for command and comma
            try {
                // begin
                updateStatus('Sending G-code: 0%');
                await writeCommand('print-raw-begin,');
                // stream chunks
                let i = 0;
                while (i < program.length) {
                    const slice = program.slice(i, i + MAX_PAYLOAD);
                    // send as print-raw-data,<chunk>
                    await writeCommand(`print-raw-data,${slice}`);
                    const pct = Math.min(100, Math.floor((i + slice.length) / program.length * 100));
                    updateStatus(`Sending G-code: ${pct}%`);
                    i += slice.length;
                }
                // end
                await writeCommand('print-raw-end,');
                updateStatus('G-code sent (chunked).');
            } catch (error) {
                updateStatus(`Chunked send failed: ${error}`);
                console.error('Chunked send error:', error);
            }
        };

        // Build a 5cm-wide ruler-like example with X & Y axes, cm and 0.5cm ticks, and numeric labels (as line strokes)
        // Origin (0,0) is bottom-left. Max area is 260x30 mm; height is capped.
        const buildSampleGcode = () => {
            const AREA_H = 30;
            const MARGIN = 0; // no margin
            const L = MARGIN, B = MARGIN;
            const WIDTH = 50; // 5cm
            const HEIGHT = Math.min(AREA_H - 2 * MARGIN, 50); // cap to available height

            const AXIS_X0 = L, AXIS_Y0 = B;
            const AXIS_X1 = L + WIDTH, AXIS_Y1 = B + HEIGHT;

            const MAJOR = 4; // major tick length (cm)
            const MINOR = 2; // half-cm tick length (5mm)
            const GAP = 1.5; // gap before labels

            // Simple seven-segment digits as line segments within w x h box
            const DIGIT_W = 3, DIGIT_H = 5;
            const segs = {
                A: [0, DIGIT_H, DIGIT_W, DIGIT_H],
                B: [DIGIT_W, DIGIT_H, DIGIT_W, DIGIT_H / 2],
                C: [DIGIT_W, DIGIT_H / 2, DIGIT_W, 0],
                D: [0, 0, DIGIT_W, 0],
                E: [0, DIGIT_H / 2, 0, 0],
                F: [0, DIGIT_H, 0, DIGIT_H / 2],
                G: [0, DIGIT_H / 2, DIGIT_W, DIGIT_H / 2],
            };
            const map = {
                0: ['A', 'B', 'C', 'D', 'E', 'F'],
                1: ['B', 'C'],
                2: ['A', 'B', 'G', 'E', 'D'],
                3: ['A', 'B', 'G', 'C', 'D'],
                4: ['F', 'G', 'B', 'C'],
                5: ['A', 'F', 'G', 'C', 'D'],
                6: ['A', 'F', 'G', 'E', 'C', 'D'],
                7: ['A', 'B', 'C'],
                8: ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
                9: ['A', 'B', 'C', 'D', 'F', 'G'],
            };

            const cmds = [];
            const moveRapid = (x, y) => { cmds.push(`M5`); cmds.push(`G0 X${x} Y${y}`); };
            const drawTo = (x, y) => { cmds.push(`M3`); cmds.push(`G1 X${x} Y${y}`); cmds.push(`M5`); };
            const drawLine = (x1, y1, x2, y2) => { moveRapid(x1, y1); drawTo(x2, y2); };
            const drawDigit = (n, ox, oy) => {
                const seglist = map[n]; if (!seglist) return;
                for (const s of seglist) {
                    const [x1, y1, x2, y2] = segs[s];
                    drawLine(ox + x1, oy + y1, ox + x2, oy + y2);
                }
            };

            // Program header
            cmds.push(`G90`); // absolute
            cmds.push(`M5`);

            // No border rectangle (drop top/right edges and margins)

            // Axes
            drawLine(AXIS_X0, AXIS_Y0, AXIS_X1, AXIS_Y0); // X axis
            drawLine(AXIS_X0, AXIS_Y0, AXIS_X0, AXIS_Y1); // Y axis

            // X-axis ticks and labels (every 5mm, labels at each cm)
            for (let i = 0; i <= WIDTH; i += 5) {
                const x = L + i;
                const len = (i % 10 === 0) ? MAJOR : MINOR;
                drawLine(x, B, x, B + len);
                if (i > 0 && i % 10 === 0) {
                    const n = Math.floor(i / 10);
                    // Center digit above tick
                    const dx = x - DIGIT_W / 2;
                    const dy = B + len + GAP;
                    drawDigit(n, dx, dy);
                }
            }

            // Y-axis ticks and labels (every 5mm, labels at each cm)
            for (let j = 0; j <= HEIGHT; j += 5) {
                const y = B + j;
                const len = (j % 10 === 0) ? MAJOR : MINOR;
                drawLine(L, y, L + len, y);
                if (j > 0 && j % 10 === 0) {
                    const n = Math.floor(j / 10);
                    if (n <= 9) {
                        const dx = L + len + GAP;
                        // vertically center on tick, but keep fully within area height
                        let dy = y - DIGIT_H / 2;
                        const dyMin = B;
                        const dyMax = B + HEIGHT - DIGIT_H;
                        if (dy < dyMin) dy = dyMin;
                        if (dy > dyMax) dy = dyMax;
                        drawDigit(n, dx, dy);
                    }
                }
            }

            return cmds.join(';');
        };

    // Crunch Labs logo sample (excerpt). Uses G21, G90, M3/M5, and F words (ignored by firmware & preview).
    const crunchLogoGcode = `G21
G90;svg > path
M5
G0 X14.232081818181818 Y29.998554545454542
M3
G1 X13.742839004217881 Y29.964603458243257 F300
G1 X13.254976504322034 Y29.914712674661487 F300
G1 X12.769001033802706 Y29.84893463011356 F300
G1 X12.28542982231813 Y29.767339332979667 F300
G1 X11.804777540644132 Y29.670013626136054 F300
G1 X11.327555752903713 Y29.55706109452712 F300
G1 X10.854272372103075 Y29.428601954918648 F300
G1 X10.385431119553578 Y29.284772927949653 F300
G1 X9.921530988754952 Y29.125727092618934 F300
G1 X9.463065714310405 Y28.951633723361184 F300
G1 X9.010523246438819 Y28.76267810988616 F300
G1 X8.56438523164334 Y28.55906135997256 F300
G1 X8.125126500089095 Y28.34100018542655 F300
G1 X7.693214560235625 Y28.108726671432724 F300
G1 X7.269109101261883 Y27.862488029542988 F300
G1 X6.853261503813405 Y27.60254633456629 F300
G1 X6.44611435959235 Y27.32917824563917 F300
G1 X6.04810100030171 Y27.042674711774037 F300
G1 X5.65964503644507 Y26.743340662198584 F300
G1 X5.281159906472745 Y26.431494681815863 F300
G1 X4.913048436754162 Y26.107468672130445 F300
G1 X4.555702412844813 Y25.7716074980016 F300
G1 X4.209502162504075 Y25.42426862059937 F300
G1 X3.8748161509077157 Y25.065821716954282 F300
G1 X3.5520005884858747 Y24.69664828650553 F300
G1 X3.2413990518039366 Y24.317141245066445 F300
G1 X2.9433421178897756 Y23.92770450663937 F300
G1 X2.6581470123965616 Y23.52875255352503 F300
G1 X2.3861172719756105 Y23.120709995183944 F300
G1 X2.127542421218598 Y22.70401111631934 F300
G1 X1.9288263638210488 Y22.361646506032013 F300
G1 X1.695523639791558 Y21.930661776612517 F300
G1 X1.4764094743442104 Y21.492285391268123 F300
G1 X1.271721006081302 Y21.04699054098632 F300
G1 X1.0816763722512643 Y20.595251778115887 F300
G1 X0.906478104114667 Y20.137550522306768 F300
G1 X0.7463129111059335 Y19.67437454745943 F300
G1 X0.601351481856387 Y19.20621746190242 F300
G1 X0.4717483022907789 Y18.733578182352158 F300
G1 X0.3576414909910568 Y18.256960402215583 F300
G1 X0.25915265200289817 Y17.776872054802244 F300
G1 X0.17638674524182818 Y17.293824772017917 F300
G1 X0.10943197463705268 Y16.808333339116604 F300
G1 X0.05835969413221953 Y16.32091514609203 F300
G1 X0.023224331643243445 Y15.832089636293212 F300
G1 X0.004063331054293684 Y15.3423777528518 F300
G1 X0.0008971123136998216 Y14.852301383511067 F300
G1 X0.013729049672340565 Y14.36238280444825 F300
G1 X0.04254546808769355 Y13.873144123682904 F300
G1 X0.08731565779737593 Y13.385106724664483 F300
G1 X0.14799190704665577 Y12.898790710632099 F300
G1 X0.2245095529350305 Y12.414714350338595 F300
G1 X0.3167870503277346 Y11.933393525729638 F300
G1 X0.42472605875867053 Y11.455341182166455 F300
G1 X0.5482115472322171 Y10.981066781778075 F300
G1 X0.6871119168121673 Y10.511075760525692 F300
G1 X0.8412791408672096 Y10.045868989557697 F300
G1 X1.0105489228234408 Y9.58594224142948 F300
G1 X1.1947408712558225 Y9.1317856617568 F300
G1 X1.393658692131993 Y8.683883246865808 F300
G1 X1.6070903980035283 Y8.242712327996406 F300
G1 X1.7905092945919083 Y7.8905182806979814 F300
G1 X5.234709090909091 Y11.334172727272728 F300
G1 X5.350342021164816 Y11.45853729885909 F300
G1 X5.453766042877051 Y11.593229064505206 F300
G1 X5.544062222287275 Y11.737051872098151 F300
G1 X5.6204298841425855 Y11.888730414492102 F300
G1 X5.682191860290699 Y12.046919726085145 F300
G1 X5.728800494272669 Y12.210217108912719 F300
G1 X5.75984249750813 Y12.377174570666098 F300
G1 X5.775042614012238 Y12.546311664345344 F300
G1 X5.774266061148503 Y12.71612861569488 F300
G1 X5.757519724774826 Y12.88511962201788 F300
G1 X5.74038728916287 Y12.9829260448629 F300
G1 X5.664892418599798 Y13.364509744319818 F300
G1 X5.605054469290616 Y13.749325263054246 F300
G1 X5.561072010402171 Y14.136273718208807 F300
G1 X5.533019266315717 Y14.524702099233668 F300
G1 X5.520943578576615 Y14.913954898070108 F300
G1 X5.524865326001171 Y15.303375215379711 F300
G1 X5.544777890285561 Y15.692305869121473 F300
G1 X5.580647667174805 Y16.08009050360599 F300
G1 X5.632414123172984 Y16.466074697155108 F300
G1 X5.699989897699012 Y16.84960706649775 F300
G1 X5.78326095051551 Y17.230040366038164 F300
G1 X5.8820867541820405 Y17.606732580141454 F300
G1 X5.996300531207877 Y17.979048006593096 F300
G1 X6.125709535504129 Y18.34635832940397 F300
G1 X6.27009537766021 Y18.708043679150475 F300
G1 X6.429214393495739 Y19.06349367906032 F300
G1 X6.602798055265911 Y19.41210847507855 F300
G1 X6.790553424826365 Y19.753299748175607 F300
G1 X6.9921636479928395 Y20.086491707188937 F300
G1 X7.207288489261281 Y20.411122060522697 F300
G1 X7.435564905986066 Y20.72664296506575 F300
G1 X7.676607661047331 Y21.0325219507265 F300
G1 X7.930009972973491 Y21.328242819024382 F300
G1 X8.195344202421795 Y21.61330651422152 F300
G1 X8.472162573858444 Y21.887231965524492 F300
G1 X8.759997931220326 Y22.14955689893482 F300
G1 X9.058364526283183 Y22.399838617378204 F300
G1 X9.366758838405705 Y22.637654747795917 F300
G1 X9.684660424266195 Y22.862603953937576 F300
G1 X10.011532796157805 Y23.074306613652404 F300
G1 X10.32445408101841 Y23.259761148682774 F300
G1 X10.667326883653535 Y23.445086284004653 F300
G1 X11.017512536212456 Y23.61618192343723 F300
G1 X11.37442479375598 Y23.772762093018642 F300
G1 X11.737462286550397 Y23.914562967192616 F300
G1 X12.10601332431117 Y24.041345622380206 F300
G1 X12.479456926854086 Y24.15289643954766 F300
G1 X12.857163870399148 Y24.24902746413809 F300
G1 X13.238497747764308 Y24.32957672276045 F300
G1 X13.622816040662673 Y24.394408496102265 F300
G1 X14.009471202296464 Y24.44341354760624 F300
G1 X14.397811748423607 Y24.47650930752546 F300
G1 X14.787183355058644 Y24.493640012047095 F300
G1 X15.176929960958377 Y24.494776797250108 F300
G1 X15.566394873034648 Y24.479917747738767 F300
G1 X15.95492187283176 Y24.449087899869937 F300
G1 X16.341856322204137 Y24.402339199568733 F300
G1 X16.726546266331336 Y24.33975041480363 F300
G1 X17.1083435322118 Y24.261427002868494 F300
G1 X17.486604820784592 Y24.16750093269514 F300
G1 X17.86069279083888 Y24.058130462495818 F300
G1 X18.229977132884915 Y23.933499873110282 F300
G1 X18.591184113188547 Y23.794899524357863 F300
G1 X18.94832763544824 Y23.640408700271422 F300
G1 X19.298824684444035 Y23.471366584728962 F300
G1 X19.64207718231953 Y23.288060444940708 F300
G1 X19.9775049409274 Y23.090800117106816 F300
G1 X20.304540998013834 Y22.879919023721964 F300
G1 X20.622632575535736 Y22.655773610002512 F300
G1 X20.93124201400284 Y22.418742741399175 F300
G1 X21.229847681265476 Y22.169227063213476 F300
G1 X21.51794485421183 Y21.907648323400483 F300
G1 X21.795046571884434 Y21.634448659702436 F300
G1 X22.060684458573903 Y21.35008985231819 F300
G1 X22.238378978706894 Y21.146062109834705 F300
G1 X22.30637701110794 Y21.05133719376263 F300
G1 X22.36031857079016 Y20.948758182295396 F300
G1 X22.399636441737073 Y20.83973410019081 F300
G1 X22.42358305621416 Y20.726337869611346 F300
G1 X22.43170310685348 Y20.610725542274853 F300
G1 X22.423842203610135 Y20.495095305508062 F300
G1 X22.400149809247175 Y20.38164568715747 F300
G1 X22.361076397535246 Y20.272533754025773 F300
G1 X22.307364888199398 Y20.16983409862513 F300
G1 X22.240036521464113 Y20.075499394049857 F300
G1 X22.16037144076994 Y19.99132326695591 F300
G1 X22.069884352851005 Y19.91890619455929 F300
G1 X21.970295727958874 Y19.859625074068532 F300
G1 X21.863499087815388 Y19.81460704314083 F300
G1 X21.75152500326285 Y19.78470804912487 F300
G1 X21.63650248613984 Y19.770496574562628 F300
G1 X21.58769090874329 Y19.76928181818326 F300
G1 X14.551890909090908 Y19.769281818181813 F300
G1 X14.435162941237412 Y19.761198183001113 F300
G1 X14.320625275094653 Y19.73728403089543 F300
G1 X14.210414623304615 Y19.697985482978503 F300
G1 X14.106586977587439 Y19.64403565794457 F300
G1 X14.011079253989339 Y19.5764409956592 F300
G1 X13.92567315950268 Y19.496462481913948 F300
G1 X13.85196195412785 Y19.40559212459896 F300
G1 X13.810641129107493 Y19.340890720208982 F300
G1 X11.555845454545453 Y15.43396363636363 F300
G1 X11.504459595359219 Y15.328599813619304 F300
G1 X11.46791298690284 Y15.217280208422173 F300
G1 X11.44685501843983 Y15.102022796273886 F300
G1 X11.441677473879622 Y14.984971943550653 F300
G1 X11.452476681538634 Y14.868305383625168 F300
G1 X11.47905172195006 Y14.754193700095215 F300
G1 X11.520908165974445 Y14.644759943033957 F300
G1 X11.555814893453688 Y14.577344036991178 F300
G1 X13.80951818181818 Y10.672618181818171 F300
G1 X13.874537409363386 Y10.575602141433757 F300
G1 X13.952223465455372 Y10.488317005982806 F300
G1 X14.04109280706219 Y10.412448314784204 F300
G1 X14.139483091459331 Y10.349415227297806 F300
G1 X14.245553882220992 Y10.300396806994678 F300
G1 X14.3573210754468 Y10.266309966421767 F300
G1 X14.47269401335603 Y10.247792315922561 F300
G1 X14.551890909136963 Y10.244281818181907 F300
G1 X21.588845454545456 Y10.24428181818181 F300
G1 X21.704607262431477 Y10.23601775388188 F300
G1 X21.818136302354187 Y10.211929416385933 F300
G1 X21.927279904381653 Y10.172473554393555 F300
G1 X22.029968552578236 Y10.118398306445448 F300
G1 X22.124255125995905 Y10.050729015166127 F300
G1 X22.20835181882122 Y9.970748785328148 F300
G1 X22.280664039683703 Y9.879974154384106 F300
G1 X22.339820647347068 Y9.780126336787257 F300
G1 X22.384699949472203 Y9.673098587348843 F300
G1 X22.41445097147881 Y9.560920302468686 F300
G1 X22.428509592218226 Y9.445718539930102 F300
G1 X22.426609240502476 Y9.329677686897872 F300
G1 X22.40878594966824 Y9.214998040870649 F300
G1 X22.37537767433422 Y9.103854088951088 F300
G1 X22.327017882307064 Y8.998353276517337 F300
G1 X22.264623543142342 Y8.900496047099738 F300
G1 X22.230732350494172 Y8.857624919752327 F300
G1 X21.972156202335462 Y8.565602730696137 F300
G1 X21.702310226914186 Y8.285003591670872 F300
G1 X21.42116323878995 Y8.015728456648247 F300
G1 X21.129190045876804 Y7.758232084066258 F300
G1 X20.826883739648395 Y7.5129493401006195 F300
G1 X20.514754862393005 Y7.280294464252139 F300
G1 X20.193330544997274 Y7.060660369768909 F300
G1 X19.863153616714627 Y6.85441798008479 F300
G1 X19.52478168842196 Y6.661915602394846 F300
G1 X19.178786210912737 Y6.4834783394256235 F300
G1 X18.82575150981692 Y6.319407540393717 F300
G1 X18.466273798777525 Y6.169980292079837 F300
G1 X18.100960172550447 Y6.035448950877857 F300
G1 X17.730427581727966 Y5.916040716609187 F300
G1 X17.355301790817503 Y5.811957248822132 F300
G1 X16.976216321435185 Y5.723374326224322 F300
G1 X16.593811382399057 Y5.6504415498233325 F300
G1 X16.208732788528753 Y5.5932820902768245 F300
G1 X15.821630869977614 Y5.5519924798789475 F300
G1 X15.433159373939226 Y5.526642449534219 F300
G1 X15.043974360583155 Y5.517274810994277 F300
G1 X14.654733095084469 Y5.52390538455634 F300
G1 X14.266092937618232 Y5.546522972345507 F300
G1 X13.878710233193559 Y5.5850893772260015 F300
G1 X13.493239203202084 Y5.639539467309426 F300
G1 X13.110330840552882 Y5.70978128595109 F300
G1 X12.924724822169695 Y5.749729254631289 F300
G1 X12.757506961063536 Y5.778336697941021 F300
G1 X12.587847807740651 Y5.791182244149632 F300
G1 X12.417732016441153 Y5.788043149665328 F300
G1 X12.248662270788955 Y5.768947143047811 F300
G1 X12.08213201437415 Y5.734062905030405 F300
G1 X11.919612258719471 Y5.683698578512725 F300
G1 X11.762538589395895 Y5.618299046642357 F300
G1 X11.612298485066258 Y5.538442003029061 F300
G1 X11.47021906147159 Y5.444832848804474 F300
G1 X11.337555348621155 Y5.338298461603099 F300
G1 X11.249763062771626 Y5.255361808969811 F300
G1 X7.8208909090909104 Y1.8264909090909016 F300
G1 X8.255846111857064 Y1.5990671764301432 F300
G1 X8.697533220883706 Y1.3861844782739219 F300
G1 X9.145930644783137 Y1.187825471180867 F300
G1 X9.600560965345252 Y1.004201352176377 F300
G1 X10.060940128063201 Y0.9134157675207231 F300
G1 X10.526577957516437 Y0.681923915639489 F300
G1 X10.996978679270846 Y0.5436137337022231 F300
G1 X11.471641447740257 Y0.4207243457000782 F300
G1 X11.950060879447323 Y0.31338659456062423 F300
G1 X12.431727591115985 Y0.22171476505513077 F300
G1 X12.916128742022607 Y0.14580646211713422 F300
G1 X13.402748580028328 Y0.08574250692041474 F300
G1 X13.89106899071126 Y0.0415868508269881 F300
G1 X14.380570049013857 Y0.01338650729673141 F300
G1 X14.870730572818113 Y0.001171501831162658 F300
G1 X15.36102867785917 Y0.004954840004659289 F300
G1 X15.850942333386522 Y0.024732493617136697 F300
G1 X16.339949917981176 Y0.060483404982973 F300
G1 X16.827530774937014 Y0.11216950935155978 F300
G1 X17.31316576661496 Y0.179735775435649 F300
G1 X17.796337827179826 Y0.2631102640043341 F300
G1 X18.276532513131198 Y0.36220420447826207 F300
G1 X18.75323855104232 Y0.47691208944554475 F300
G1 X19.225948381923704 Y0.6071117869977307 F300
G1 X19.69415870163191 Y0.7526646707662241 F300
G1 X20.157370996748107 Y0.9134157675207231 F300
G1 X20.615092075355825 Y1.0891939221724733 F300
G1 X21.066834592152826 Y1.2798119800067127 F300
G1 X21.512117567337935 Y1.4850669859502563 F300
G1 X21.950466898720393 Y1.7047404006620486 F300
G1 X22.38141586650648 Y1.938598333216607 F300
G1 X22.80450563022594 Y2.186391790132644 F300
G1 X23.219285717269113 Y2.44785694048168 F300
G1 X23.625314502514655 Y2.7227153967944044 F300
G1 X24.022159678537125 Y3.0106745114657087 F300
G1 X24.409398715893833 Y3.3114276883427554 F300
G1 X24.786619313000866 Y3.6246547091643926 F300
G1 X25.1534198351193 Y3.950022074504295 F300
G1 X25.50940974198418 Y4.287183358854856 F300
G1 X25.854210003621006 Y4.635779579473732 F300
G1 X26.18745350390693 Y4.995439578600365 F300
G1 X26.50878543144708 Y5.365780418635483 F300
G1 X26.630648857988916 Y5.512836458954238 F300
G1 X26.934522941093892 Y5.897200101591757 F300
G1 X27.22567370981925 Y6.291264555085139 F300
G1 X27.50380322600148 Y6.69462486035159 F300
G1 X27.768614926358637 Y7.106850923319904 F300
G1 X28.019826448097902 Y7.52750319655975 F300
G1 X28.257169929992696 Y7.956133147961261 F300
G1 X28.480392297997142 Y8.392283738994784 F300
G1 X28.689255535093245 Y8.835489912040854 F300
G1 X28.88353693508311 Y9.28527908627072 F300
G1 X29.063029340055582 Y9.741171661548716 F300
G1 X29.2275413612741 Y10.202681529819163 F300
G1 X29.37689758325022 Y10.669316593432503 F300
G1 X29.510938750785222 Y11.14057928985803 F300
G1 X29.62952193878038 Y11.61596712222368 F300
G1 X29.73252070463478 Y12.094973195117204 F300
G1 X29.819825223068257 Y12.57708675507741 F300
G1 X29.891342403225625 Y13.061793735199156 F300
G1 X29.94699598793736 Y13.548577303271395 F300
G1 X29.986726635030934 Y14.03691841286379 F300
G1 X30.010491980606048 Y14.526296356774322 F300
G1 X30.01826668420629 Y15.016189322247735 F300
G1 X30.010042455839113 Y15.506074947372793 F300
G1 X29.985828064815266 Y15.995430878065116 F300
G1 X29.94564933039828 Y16.483735325041646 F300
G1 X29.889549094273946 Y16.970467620192892 F300
G1 X29.817587174869203 Y17.45510877175969 F300
G1 X29.729840303569084 Y17.9371420177225 F300
G1 X29.626402042899738 Y18.416053376813206 F300
G1 X29.507382686764835 Y18.891332196561823 F300
G1 X29.372909142841607 Y19.362471697793822 F300
G1 X29.22312479726206 Y19.828969514997407 F300
G1 X29.058189361723528 Y20.29032823198466 F300
G1 X28.878278703191675 Y20.746055912275246 F300
G1 X28.683584656377487 Y21.195666623637333 F300
G1 X28.474314819188187 Y21.63868095622621 F300
G1 X28.250692331370253 Y22.07462653376832 F300
G1 X28.012955636580493 Y22.503038517245493 F300
G1 X27.76135822813891 Y22.923460100542407 F300
G1 X27.496168378734417 Y23.335442997528716 F300
G1 X27.217668854371723 Y23.73854792005653 F300
G1 X26.92615661286421 Y24.132345046363554 F300
G1 X26.621942487194495 Y24.516414479382405 F300
G1 X26.305350854080174 Y24.890346694467453 F300
G1 X25.976719288098153 Y25.253742976061815 F300
G1 X25.636398201736462 Y25.60621584283883 F300
G1 X25.284750471757235 Y25.9473894608647 F300
G1 X24.92215105226935 Y26.27690004434185 F300
G1 X24.548986574923227 Y26.59439624350556 F300
G1 X24.165654936654185 Y26.899539519260372 F300
G1 X23.7725648754138 Y27.19200450415675 F300
G1 X23.370135534341795 Y27.471479349323104 F300
G1 X22.95879601484308 Y27.737666056983286 F300
G1 X22.538984919046506 Y27.99028079820495 F300
G1 X22.111149882133258 Y28.229054215539968 F300
G1 X21.67574709503344 Y28.453731710234294 F300
G1 X21.23324081799992 Y28.664073713700883 F300
G1 X20.99055983034516 Y28.77202627382298 F300
G1 X20.537796189715188 Y28.96016464972528 F300
G1 X20.079138113364483 Y29.13342988491563 F300
G1 X19.615071106788967 Y29.29163824795419 F300
G1 X19.14608930989889 Y29.43462127811179 F300
G1 X18.67269209588763 Y29.562226726638386 F300
G1 X18.19538353949768 Y29.674318718877977 F300
G1 X17.714671880280378 Y29.770777898948324 F300
G1 X17.23106898142093 Y29.85150155683148 F300
G1 X16.745089784705 Y29.91640373773966 F300
G1 X16.257251762207186 Y29.96541533364021 F300
G1 X15.768074365285225 Y29.998484156842004 F300
G1 X15.278078471466674 Y30.015574995565068 F300
G1 X14.78778582981699 Y30.01666965143419 F300
G1 X14.297718505379587 Y30.001766958856578 F300
G1 X14.232070573061929 Y29.998553970435047 F300
M5`;

        // --- G-code preview renderer (SVG) ---
        const MAX_X = 260, MAX_Y = 30;
        const clearNode = (node) => { while (node.firstChild) node.removeChild(node.firstChild); };
        const parseAndRenderGcode = (program) => {
            clearNode(gcodePreview);

            // Draw area border (tape edges) and keep fill transparent; tape color provided by container
            const border = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            border.setAttribute('x', '0');
            border.setAttribute('y', '0');
            border.setAttribute('width', String(MAX_X));
            border.setAttribute('height', String(MAX_Y));
            border.setAttribute('fill', 'transparent');
            border.setAttribute('stroke', 'rgba(255,255,255,0.25)');
            border.setAttribute('stroke-width', '0.4');
            gcodePreview.appendChild(border);

            // Flip Y so (0,0) is bottom-left visually
            const gg = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            gg.setAttribute('transform', `scale(1,-1) translate(0, -${MAX_Y})`);
            gcodePreview.appendChild(gg);

            let abs = true;
            let pen = false;
            let x = 0, y = 0;
            let path = '';
            const addSeg = (nx, ny) => {
                if (!pen) return;
                if (!path) path = `M ${x} ${y}`;
                path += ` L ${nx} ${ny}`;
            };

            const lines = program.split(/[;\n\r]+/);
            for (let raw of lines) {
                let line = raw.replace(/\(.*?\)/g, '').trim();
                if (!line) continue;
                if (line.startsWith(';')) continue;
                line = line.replace(/\s+/g, ' ').toUpperCase();
                const words = line.split(' ');
                const w0 = words[0];
                if (w0.startsWith('G')) {
                    const num = parseInt(w0.slice(1), 10) || 0;
                    let nx = x, ny = y;
                    for (let i = 1; i < words.length; i++) {
                        const w = words[i];
                        if (w.startsWith('X')) nx = parseFloat(w.slice(1));
                        else if (w.startsWith('Y')) ny = parseFloat(w.slice(1));
                    }
                    if (num === 90) { abs = true; continue; }
                    if (num === 91) { abs = false; continue; }
                    if (num === 0 || num === 1) {
                        const tx = abs ? nx : x + nx;
                        const ty = abs ? ny : y + ny;
                        const cx = Math.max(0, Math.min(MAX_X, tx));
                        const cy = Math.max(0, Math.min(MAX_Y, ty));
                        if (num === 1) addSeg(cx, cy);
                        x = cx; y = cy;
                    }
                } else if (w0.startsWith('M')) {
                    const num = parseInt(w0.slice(1), 10) || 0;
                    if (num === 3) { // pen down
                        // start new subpath at current pos always
                        if (path) path += ` M ${x} ${y}`; else path = `M ${x} ${y}`;
                        pen = true;
                    } else if (num === 5) { // pen up
                        pen = false;
                    } else if (num === 300) {
                        // M300 Sxx heuristic
                        let s = null;
                        for (let i = 1; i < words.length; i++) if (words[i].startsWith('S')) s = parseFloat(words[i].slice(1));
                        if (s !== null) {
                            const down = (s < 60);
                            if (down && !pen) {
                                if (path) path += ` M ${x} ${y}`; else path = `M ${x} ${y}`;
                                pen = true;
                            } else if (!down && pen) {
                                pen = false;
                            }
                        }
                    }
                }
            }

            if (path) {
                const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                p.setAttribute('d', path);
                p.setAttribute('fill', 'none');
                // Silver paint effect on purple tape
                p.setAttribute('stroke', '#d5dbe6');
                p.setAttribute('stroke-opacity', '0.95');
                p.setAttribute('stroke-width', String(currentStrokeWidth));
                p.setAttribute('stroke-linecap', 'round');
                p.setAttribute('stroke-linejoin', 'round');
                gg.appendChild(p);
            }
        };

        // UI actions
        const sendPenDown = () => writeCommand('pen-down,');
        const sendPenUp = () => writeCommand('pen-up,');
        const sendText = () => {
            const txt = (labelTextInput.value || '').trim();
            if (!txt) {
                updateStatus('Enter some text to print.');
                return;
            }
            if (txt.length > 400) {
                updateStatus('Text too long for single BLE write. Keep under ~400 chars.');
                return;
            }
            writeCommand(`print-text,${txt}`);
            updateStatus(`Sent text: "${txt}"`);
            labelTextInput.value = '';
        };
        const sendSampleGcode = () => {
            const g = (gcodeTextarea.value || '').trim();
            if (!g) {
                updateStatus('No G-code to send.');
                return;
            }
            // decide chunking based on size
            if (g.length > 420) {
                sendGcodeChunked(g);
            } else {
                writeCommand(`print-raw,${g}`);
            }
        };
        const resetToSample = () => {
            const g = buildSampleGcode();
            gcodeTextarea.value = g;
            parseAndRenderGcode(g);
        };

        /**
         * Disconnects from the device.
         */
        const disconnectDevice = () => {
            if (labelMakerDevice && labelMakerDevice.gatt.connected) {
                labelMakerDevice.gatt.disconnect();
                updateStatus('Disconnected.');
            } else {
                updateStatus('Device is already disconnected.');
            }
        };

        /**
         * Handler for when the device unexpectedly disconnects.
         */
    const onDisconnected = () => {
            updateStatus('Device disconnected.');
            // Reset state
            labelMakerDevice = null;
            labelMakerCharacteristic = null;
            connectButton.disabled = false;
            penDownButton.disabled = true;
            penUpButton.disabled = true;
            sendTextButton.disabled = true;
            sendSampleGcodeButton.disabled = true;
            disconnectButton.disabled = true;
        };

        // Attach event listeners to buttons
        connectButton.addEventListener('click', connectDevice);
        penDownButton.addEventListener('click', sendPenDown);
        penUpButton.addEventListener('click', sendPenUp);
        sendTextButton.addEventListener('click', sendText);
        sendSampleGcodeButton.addEventListener('click', sendSampleGcode);
        disconnectButton.addEventListener('click', disconnectDevice);
        resetToSampleButton.addEventListener('click', resetToSample);
        const loadCrunchLabs = () => {
            gcodeTextarea.value = crunchLogoGcode;
            parseAndRenderGcode(crunchLogoGcode);
            updateStatus('Loaded Crunch Labs logo sample into viewer.');
        };
        loadCrunchLabsButton.addEventListener('click', loadCrunchLabs);
        gcodeTextarea.addEventListener('input', (e) => parseAndRenderGcode(e.target.value));
        thicknessSlider.addEventListener('input', (e) => {
            const v = parseFloat(e.target.value);
            currentStrokeWidth = isFinite(v) ? v : 2.0;
            thicknessValue.textContent = `${currentStrokeWidth.toFixed(1)} mm`;
            parseAndRenderGcode(gcodeTextarea.value || '');
        });

        // Tabs
        const tabText = document.getElementById('tabText');
        const tabGcode = document.getElementById('tabGcode');
        const tabRaw = document.getElementById('tabRaw');
        const sectionText = document.getElementById('sectionText');
        const sectionGcode = document.getElementById('sectionGcode');
        const sectionRaw = document.getElementById('sectionRaw');

        const setActiveTab = (target) => {
            const tabs = [tabText, tabGcode, tabRaw];
            const sections = [sectionText, sectionGcode, sectionRaw];
            tabs.forEach((t, i) => {
                const active = t === target;
                t.classList.toggle('active', active);
                sections[i].classList.toggle('hidden', !active);
            });
            // Re-render preview if switching to G-code
            if (target === tabGcode) {
                parseAndRenderGcode(gcodeTextarea.value || '');
            }
        };
        tabText.addEventListener('click', () => setActiveTab(tabText));
        tabGcode.addEventListener('click', () => setActiveTab(tabGcode));
        tabRaw.addEventListener('click', () => setActiveTab(tabRaw));

        // Initialize textarea with sample and render preview
        (function initSample() {
            const g = buildSampleGcode();
            gcodeTextarea.value = g;
            parseAndRenderGcode(g);
        })();
    </script>
</body>

</html>